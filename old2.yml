# name: Build AndroidAPS

# on:
#   push:
#     branches: [master]
#   pull_request:
#     branches: [master]
#   workflow_dispatch:
#     inputs:
#       user_id:
#         description: "User ID for API calls"
#         required: true
#         type: string
#       branch:
#         description: "Branch to build from"
#         required: true
#         type: string
#         default: "master"

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Signing on
#         run: |
#           curl -X POST "${{ secrets.API_URL_SIGNING_ON }}" \
#             -H "Content-Type: application/json" \
#             -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
#             -d '{"user_id":"${{github.event.inputs.user_id}}", "run_id":"${{ github.run_id }}"}'

#       - name: Print Availability Secrets
#         run: |
#           echo "Available secrets:"
#           echo "KEY_BASE64: ${{ secrets.KEY_BASE64 != '' && '✓' || '✗' }}"
#           echo "SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS != '' && '✓' || '✗' }}"
#           echo "SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD != '' && '✓' || '✗' }}"
#           echo "SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD != '' && '✓' || '✗' }}"

#       - name: Decode Keystore
#         run: |
#           echo "${{ secrets.KEY_BASE64 }}" > $GITHUB_WORKSPACE/androidaps.keystore.base64
#           base64 -d $GITHUB_WORKSPACE/androidaps.keystore.base64 > $GITHUB_WORKSPACE/androidaps.keystore
#           rm $GITHUB_WORKSPACE/androidaps.keystore.base64
#           echo "Keystore location: $GITHUB_WORKSPACE/androidaps.keystore"
#           ls -l $GITHUB_WORKSPACE/androidaps.keystore

#       - name: Keystore validation
#         run: |
#           keytool -list -v -keystore $GITHUB_WORKSPACE/androidaps.keystore -storepass ${{ secrets.SIGNING_STORE_PASSWORD }} -alias ${{ secrets.SIGNING_KEY_ALIAS }} > $GITHUB_WORKSPACE/keystore.txt
#           cat $GITHUB_WORKSPACE/keystore.txt

#       - name: Checkout this repo (for workflow files)
#         uses: actions/checkout@v4

#       - name: Set up JDK 21 (no Gradle cache – project cloned later)
#         uses: actions/setup-java@v4
#         with:
#           java-version: "21"
#           distribution: "temurin"
#           # No cache here

#       - name: Clone original AndroidAPS repo at tag 3.4.0.0
#         run: |
#           git clone https://github.com/nightscout/AndroidAPS.git source
#           cd source
#           git fetch --tags --force
#           git checkout 3.4.0.0

#       - name: Grant execute permission for gradlew
#         working-directory: source
#         run: chmod +x ./gradlew

#       - name: Accept Android SDK licenses (if prompted)
#         working-directory: source
#         run: |
#           yes | ./gradlew --no-daemon sdk:acceptLicenses || true

#       - name: Build Smartphone (Full) APK
#         working-directory: source
#         run: ./gradlew assembleFullDebug --stacktrace --info

#       - name: Build Smartwatch (Wear) APK
#         working-directory: source
#         run: ./gradlew :wear:assembleDebug --stacktrace --info

#       - name: Build Client (Aapsclient) APK
#         working-directory: source
#         run: ./gradlew assembleAapsclientDebug --stacktrace --info

#       - name: Upload Debug APKs as Artifacts
#         uses: actions/upload-artifact@v4
#         with:
#           name: aaps-3.4.0.0-debug-apks
#           path: |
#             source/app/build/outputs/apk/full/debug/*.apk
#             source/wear/build/outputs/apk/debug/*.apk
#             source/app/build/outputs/apk/aapsclient/debug/*.apk
#           if-no-files-found: error
#           retention-days: 1

#       - name: Signing off
#         run: |
#           curl -X POST "${{ secrets.API_URL_SIGNING_OFF }}" \
#             -H "Content-Type: application/json" \
#             -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
#             -d '{
#               "user_id": "${{ github.event.inputs.user_id }}",
#               "run_id": "${{ github.run_id }}",
#               "download_url": {
#                 "phone": "${{ steps.upload-artifact-phone.outputs.artifact-url }}",
#                 "smartwatch": "${{ steps.upload-artifact-watch.outputs.artifact-url }}"
#               }
#             }'
